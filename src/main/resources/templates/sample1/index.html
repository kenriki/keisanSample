<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>è¨ˆç®—ã®ãƒšãƒ¼ã‚¸</title>
	<style>
		/* --- æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) --- */
		#keypad {
			position: absolute;
			padding: 10px;
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			border-radius: 5px;
			z-index: 100;
		}

		.keypad-hidden {
			display: none;
		}

		.keypad-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 5px;
		}

		#keypad button {
			padding: 15px;
			font-size: 18px;
			cursor: pointer;
			border: none;
			background-color: #fff;
			border-radius: 3px;
			transition: background-color 0.2s;
		}

		#operators {
			margin-top: 10px;
			display: flex;
			gap: 5px;
			width: fit-content;
		}

		.operator-btn {
			padding: 10px 15px;
			font-size: 18px;
			cursor: pointer;
			border: 1px solid #ccc;
			background-color: #e9e9e9;
			border-radius: 3px;
			flex-grow: 0;
			width: auto;
		}

		.operator-btn.selected {
			background-color: #007bff;
			color: white;
			border-color: #0056b3;
			font-weight: bold;
		}

		.calculation-row-group {
			margin-bottom: 10px;
		}

		.calculation-row input[type="text"] {
			width: 100px;
		}

		.calculation-row {
			display: flex;
			align-items: center;
			margin-bottom: 5px;
			gap: 5px;
		}

		.calculation-row span {
			font-weight: bold;
		}

		/* ç­†ç®—è¡¨ç¤ºé ˜åŸŸã®ã‚¹ã‚¿ã‚¤ãƒ« */
		.calculation-process {
			margin-left: 0;
			padding-left: 0;
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			font-size: 18px;
			color: #333;
			width: fit-content;
		}

		.math-row {
			display: grid;
			grid-template-columns: 20px repeat(var(--cols), 1fr);
			font-family: monospace;
			line-height: 1.2;
		}

		.digit {
			text-align: center;
			min-width: 1.1em;
		}

		.operator-cell {
			grid-column: 1;
			text-align: center;
			font-weight: bold;
		}

		/* åŠ ç®—ãƒ»æ¸›ç®—ãƒ»ä¹—ç®—ã®ç·š */
		.horizontal-line {
			display: grid;
			grid-template-columns: 20px repeat(var(--cols), 1fr);
			width: 100%;
			margin-top: -2px;
			margin-bottom: 2px;
		}

		.line-area {
			grid-column: 2 / span var(--cols);
			border-bottom: 2px solid #333;
		}

		.carry-row .digit {
			font-size: 12px;
			line-height: 1;
			min-height: 12px;
			color: red;
		}

		.multiplication-line {
			display: grid;
			grid-template-columns: 20px repeat(var(--cols), 1fr);
			width: 100%;
			margin-top: -2px;
			margin-bottom: 2px;
		}

		.multiplication-line .line-area {
			grid-column: 2 / span var(--cols);
			border-bottom: 1px solid #777;
		}

		/* --- å‰²ã‚Šç®—å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« ğŸ’¡ ä¿®æ­£ --- */
		.division-container {
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			font-family: monospace;
			font-size: 18px;
			/* å‰²ã‚Šç®—ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…¨ä½“ã®å¹…ã‚’èª¿æ•´ */
			max-width: 300px;
		}

		.quotient-row {
			border-bottom: 2px solid #333;
			padding-bottom: 2px;
			min-height: 1.2em;
			margin-left: 10px;
			display: flex;
			/* å•†ã‚’ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã§é…ç½® */
			justify-content: flex-end;
			width: 100%;
		}

		.quotient-digit {
			min-width: 1.1em;
			text-align: center;
		}

		.division-main {
			display: flex;
			align-items: flex-start;
		}

		.division-symbol {
			border-left: 2px solid #333;
			border-bottom: 2px solid #333;
			padding-left: 5px;
			padding-right: 5px;
			line-height: 1.2;
			margin-top: -2px;
			font-weight: bold;
			min-height: 1.2em;
		}

		.division-steps {
			display: flex;
			flex-direction: column;
			margin-left: 5px;
			min-width: 100px;
		}

		.step-row {
			display: flex;
			/* å³å¯„ã›ã‚’ç¶­æŒã™ã‚‹ãŸã‚flex-end */
			justify-content: flex-end;
			width: 100%;
			line-height: 1.2;
		}

		/* å‰²ã‚‰ã‚Œã‚‹æ•°ã€å¼•ãç®—ã®è¡Œ */
		.step-content {
			display: flex;
			justify-content: flex-end;
			min-width: 100px;
		}

		.step-digit {
			min-width: 1.1em;
			text-align: center;
		}

		.step-operator {
			min-width: 1.1em;
			text-align: right;
			font-weight: bold;
		}

		.step-line {
			border-bottom: 1px solid #777;
			margin-top: -2px;
			margin-bottom: 2px;
			width: 100%;
		}

		.remainder-line {
			padding-top: 5px;
			font-weight: bold;
			width: 100%;
			text-align: right;
		}
	</style>
</head>

<body>
	<h1>è¨ˆç®—ã®ãƒšãƒ¼ã‚¸</h1>

	<button type="button" id="addRowButton">è¡Œã‚’è¿½åŠ </button>
	<br>

	<form action="/calculate" method="post" id="calculationForm">

		<div id="calculationRowsContainer">

			<div class="calculation-row-group" id="group_1">
				<div class="calculation-row">
					<input type="text" id="number1_1" name="number1_1" placeholder="x=" readonly>

					<span id="operator_1" data-operator="+">+</span>

					<input type="text" id="number2_1" name="number2_1" placeholder="y=" readonly>
					=
					<input type="text" id="result_1" name="result_1" readonly>
				</div>
				<div id="process_1" class="calculation-process"></div>
			</div>
		</div>

		<div id="operators">
			<button type="button" class="operator-btn selected" data-operator="+" id="op_add">+</button>
			<button type="button" class="operator-btn" data-operator="-" id="op_subtract">-</button>
			<button type="button" class="operator-btn" data-operator="*" id="op_multiply">Ã—</button>
			<button type="button" class="operator-btn" data-operator="/" id="op_divide">Ã·</button>
		</div>

		<button type="submit" id="calculateSubmit">è¨ˆç®—</button>
	</form>

	<div id="keypad" class="keypad-hidden">
		<div class="keypad-grid">
			<button data-value="7">7</button>
			<button data-value="8">8</button>
			<button data-value="9">9</button>
			<button data-value="4">4</button>
			<button data-value="5">5</button>
			<button data-value="6">6</button>
			<button data-value="1">1</button>
			<button data-value="2">2</button>
			<button data-value="3">3</button>
			<button data-value="C" class="clear-key">C</button>
			<button data-value="0">0</button>
			<button data-value="." class="decimal-key">.</button>
		</div>
	</div>
	<noscript>JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</noscript>

	<script th:inline="javascript">
		// =======================================================
		// 1. å¤‰æ•°ã®å®šç¾©
		// =======================================================
		const calculationRowsContainer = document.getElementById('calculationRowsContainer');
		const keypad = document.getElementById('keypad');
		const operatorButtons = document.querySelectorAll('.operator-btn');
		const addRowButton = document.getElementById('addRowButton');

		let currentInput = null;
		let activeRowId = 1;

		// ------------------------------------------------------------------
		// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° (generateMathHTML - æ¡æƒãˆHTMLç”Ÿæˆ) 
		// ------------------------------------------------------------------
		// (åŠ ç®—ãƒ»æ¸›ç®—ãƒ»ä¹—ç®—ã®ç­†ç®—è¡¨ç¤ºã§ä½¿ç”¨)
		function generateMathHTML(operator, strX, strY, finalResult, carriesOrBorrows) {

			const numCols = finalResult.length;
			let html = '';

			const gridStyle = `style="--cols: ${numCols}"`;

			// 1. ç¹°ã‚Šä¸ŠãŒã‚Š/ç¹°ã‚Šä¸‹ãŒã‚Šã®è¡Œ
			if (carriesOrBorrows && carriesOrBorrows.some(c => c !== '')) {
				const carryRow = carriesOrBorrows.join('');
				html += `<div class="math-row carry-row" ${gridStyle}>`;
				html += `<div class="operator-cell"></div>`;

				const paddedCarry = carryRow.padStart(numCols, ' ');
				for (let i = 0; i < numCols; i++) {
					html += `<div class="digit">${paddedCarry[i] === ' ' ? '' : paddedCarry[i]}</div>`;
				}
				html += `</div>`;
			}

			// 2. æœ€åˆã®æ•° (X)
			html += `<div class="math-row" ${gridStyle}>`;
			html += `<div class="operator-cell"></div>`;

			const paddedX = strX.padStart(numCols, ' ');
			for (let i = 0; i < numCols; i++) {
				html += `<div class="digit">${paddedX[i]}</div>`;
			}
			html += `</div>`;

			// 3. 2ç•ªç›®ã®æ•° (Y) ã¨æ¼”ç®—å­
			html += `<div class="math-row" ${gridStyle}>`;
			html += `<div class="operator-cell">${operator}</div>`;

			const paddedY = strY.padStart(numCols, ' ');
			for (let i = 0; i < numCols; i++) {
				html += `<div class="digit">${paddedY[i]}</div>`;
			}
			html += `</div>`;

			// ç·šå°‚ç”¨ã® div
			html += `<div class="horizontal-line" ${gridStyle}><div class="operator-cell"></div><div class="line-area"></div></div>`;

			// 4. ç­”ãˆã®è¡Œ
			html += `<div class="math-row answer-row" ${gridStyle}>`;
			html += `<div class="operator-cell"></div>`;

			for (let i = 0; i < numCols; i++) {
				html += `<div class="digit">${finalResult[i]}</div>`;
			}
			html += `</div>`;

			return html;
		}

		// (showAdditionProcess, showSubtractionProcess, showMultiplicationProcess ã¯çœç•¥ã›ãšã«ç¶­æŒ)

		function showAdditionProcess(rowId, x, y) {
			const processElement = document.getElementById(`process_${rowId}`);
			if (!processElement) return;

			let strX = String(Math.abs(x));
			let strY = String(Math.abs(y));
			const maxLength = Math.max(strX.length, strY.length);

			let digitsX = strX.split('').map(Number).reverse();
			let digitsY = strY.split('').map(Number).reverse();
			let resultDigits = [];
			let carries = [];
			let carry = 0;

			for (let i = 0; i < maxLength; i++) {
				const dX = digitsX[i] || 0;
				const dY = digitsY[i] || 0;

				const sum = dX + dY + carry;
				resultDigits.push(sum % 10);
				carry = Math.floor(sum / 10);
				carries.push(carry);
			}

			if (carry > 0) {
				resultDigits.push(carry);
			}

			const rawFinalResult = resultDigits.reverse().join('');
			const finalResult = String(parseInt(rawFinalResult, 10));

			let adjustedCarries = carries.reverse().map(c => c > 0 ? String(c) : '');

			if (adjustedCarries.length > finalResult.length - 1) {
				adjustedCarries.shift();
			}

			const carryLine = adjustedCarries.map(c => c || ' ').join('').padStart(finalResult.length - 1, ' ').split('');


			processElement.innerHTML = generateMathHTML('+', strX, strY, finalResult, carryLine);
		}

		function showSubtractionProcess(rowId, x, y) {
			const processElement = document.getElementById(`process_${rowId}`);
			if (!processElement || x < y) {
				showSimpleProcess(rowId, x, y, '-', x - y);
				return;
			}

			let strX = String(x);
			let strY = String(y);
			const maxLength = Math.max(strX.length, strY.length);

			let digitsX = strX.split('').map(Number);
			let digitsY = strY.split('').map(Number);

			while (digitsX.length < maxLength) digitsX.unshift(0);
			while (digitsY.length < maxLength) digitsY.unshift(0);

			let resultDigits = [];
			let borrows = [];

			let modifiedDigitsX = [...digitsX];

			for (let i = maxLength - 1; i >= 0; i--) {
				let dX = modifiedDigitsX[i];
				const dY = digitsY[i];

				if (dX < dY) {
					dX += 10;

					for (let j = i - 1; j >= 0; j--) {
						if (modifiedDigitsX[j] > 0) {
							modifiedDigitsX[j] -= 1;
							borrows[j] = 'â†“';
							break;
						} else {
							modifiedDigitsX[j] = 9;
						}
					}
				}

				resultDigits.unshift(dX - dY);
			}

			const rawFinalResult = resultDigits.join('');
			const finalResult = String(parseInt(rawFinalResult, 10));

			let adjustedBorrows = [];
			const diff = maxLength - finalResult.length;

			for (let i = 0; i < finalResult.length; i++) {
				adjustedBorrows.push(borrows[i + diff] || '');
			}

			processElement.innerHTML = generateMathHTML('-', strX, strY, finalResult, adjustedBorrows);
		}

		function showMultiplicationProcess(rowId, x, y) {
			const processElement = document.getElementById(`process_${rowId}`);
			if (!processElement) return;

			let strX = String(x);
			let strY = String(y);
			let finalResult = String(x * y);

			const maxLenY = strY.length;
			const maxCols = finalResult.length;
			const gridStyle = `style="--cols: ${maxCols}"`;

			let html = '';

			// 1. æœ€åˆã®æ•° (X)
			html += `<div class="math-row" ${gridStyle}>`;
			html += `<div class="operator-cell"></div>`;
			let paddedX = strX.padStart(maxCols, ' ');
			for (let i = 0; i < maxCols; i++) {
				html += `<div class="digit">${paddedX[i] || ' '}</div>`;
			}
			html += `</div>`;

			// 2. 2ç•ªç›®ã®æ•° (Y) ã¨æ¼”ç®—å­
			html += `<div class="math-row" ${gridStyle}>`;
			html += `<div class="operator-cell">Ã—</div>`;
			let paddedY = strY.padStart(maxCols, ' ');
			for (let i = 0; i < maxCols; i++) {
				html += `<div class="digit">${paddedY[i] || ' '}</div>`;
			}
			html += `</div>`;

			// 3. ä¸­é–“ç·š (YãŒ1æ¡ã§ãªã„å ´åˆã®ã¿)
			if (maxLenY > 1) {
				html += `<div class="multiplication-line" ${gridStyle}><div class="operator-cell"></div><div class="line-area"></div></div>`;
			}

			// 4. éƒ¨åˆ†ç©ã®è¨ˆç®— (Yã®æ¡æ•°åˆ†)
			let digitsY = strY.split('').map(Number).reverse();
			for (let i = 0; i < maxLenY; i++) {
				const digitY = digitsY[i];
				const partialProduct = x * digitY;
				let strPartialProduct = String(partialProduct);

				// éƒ¨åˆ†ç©ã®æ¡ã‚’ãšã‚‰ã™ (iã¯0ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€iå€‹ã® '0' ã‚’è¿½åŠ )
				strPartialProduct += '0'.repeat(i);

				html += `<div class="math-row" ${gridStyle}>`;
				html += `<div class="operator-cell"></div>`;

				let paddedPartial = strPartialProduct.padStart(maxCols, ' ');

				for (let j = 0; j < maxCols; j++) {
					html += `<div class="digit">${paddedPartial[j] || ' '}</div>`;
				}
				html += `</div>`;
			}

			// 5. æœ€çµ‚ç·š
			html += `<div class="horizontal-line" ${gridStyle}><div class="operator-cell"></div><div class="line-area"></div></div>`;

			// 6. ç­”ãˆã®è¡Œ
			html += `<div class="math-row answer-row" ${gridStyle}>`;
			html += `<div class="operator-cell"></div>`;

			let paddedFinal = finalResult.padStart(maxCols, ' ');
			for (let i = 0; i < maxCols; i++) {
				html += `<div class="digit">${paddedFinal[i] || ' '}</div>`;
			}
			html += `</div>`;

			processElement.innerHTML = html;
		}

		// ------------------------------------------------------------------
		// é€”ä¸­å¼ãƒ­ã‚¸ãƒƒã‚¯ (å‰²ã‚Šç®—) ğŸ’¡ ä¿®æ­£
		// ------------------------------------------------------------------
		function showDivisionProcess(rowId, x, y) {
			const processElement = document.getElementById(`process_${rowId}`);
			if (!processElement) return;

			if (y === 0) {
				processElement.innerHTML = '<div>ãœã‚ã§ã¯ã‚ã‚Œãªã„ã‚ˆï¼</div>';
				return;
			}

			if (!Number.isInteger(x) || !Number.isInteger(y) || x < 0 || y < 0) {
				processElement.innerHTML = '<div>æ•´æ•°åŒå£«ã®æ­£ã®æ•°ã®å‰²ã‚Šç®—ç­†ç®—ã«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</div>';
				return;
			}

			const initialY = y;
			const strX = String(x);
			const strY = String(y);
			const strQ = String(Math.floor(x / y));
			const qLen = strQ.length;

			// å‰²ã‚Šç®—ã®ä¸»è¦éƒ¨åˆ†ã®æ¡æ•°
			const mainCols = strX.length + 1; // å‰²ã‚‰ã‚Œã‚‹æ•° + 1æ¡ã®ä½™ç™½

			let stepsHTML = '';
			let currentRemainder = 0; // ç¾åœ¨ã®ä½™ã‚Šï¼ˆå¼•ãç®—ã®çµæœï¼‰
			let dividendIndex = 0;    // å‰²ã‚‰ã‚Œã‚‹æ•°(strX)ã®ç¾åœ¨è¦‹ã¦ã„ã‚‹æ¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
			let quotientIndex = 0;    // å•†(strQ)ã®ç¾åœ¨åŸ‹ã‚ãŸæ¡æ•°

			// å•†ã®æ¡æ•°åˆ†ã€ä¸»è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¹°ã‚Šè¿”ã™
			while (quotientIndex < qLen) {

				// 1. å‰²ã‚‰ã‚Œã‚‹æ•°ã®æ–°ã—ã„éƒ¨åˆ† (ç¾åœ¨ã®ä½™ã‚Š + æ–°ã—ãå¼•ãä¸‹ã‚ã—ãŸæ¡) ã‚’ä½œã‚‹
				let workingDividend = currentRemainder * 10;

				// å•†ã®æ¡ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã«ã€å‰²ã‚‰ã‚Œã‚‹æ•°ã‹ã‚‰æ–°ã—ã„æ¡ã‚’å¼•ãä¸‹ã‚ã™
				while (workingDividend < initialY && dividendIndex < strX.length) {
					workingDividend += parseInt(strX[dividendIndex], 10);
					dividendIndex++;
				}

				// å•†ã®æ¡ã‚’è¨ˆç®— (å•†ãŒ0ã§ã€ã‹ã¤ã¾ã å…ˆé ­ã§ãªã„å ´åˆã¯æ¬¡ã®ãƒ«ãƒ¼ãƒ—ã§æ¡ã‚’å¼•ãä¸‹ã‚ã™)
				let qDigit = Math.floor(workingDividend / initialY);

				// å•†ã®æ¡ãŒç¢ºå®šã—ãŸã‚‰ã€å•†ã®é…åˆ—ã‚’åŸ‹ã‚ã‚‹
				if (qDigit > 0 || quotientIndex > 0) {
					quotientIndex++;
				} else {
					// å•†ã®å…ˆé ­ãŒ 0 ã®å ´åˆ (ä¾‹: 15 / 50) ã¯ã“ã“ã§çµ‚äº†
					if (dividendIndex === strX.length) break;
					continue;
				}

				// 2. éƒ¨åˆ†ç© (product) ã‚’è¨ˆç®—
				let product = qDigit * initialY;

				// 3. å¼•ãç®—ã®çµæœ (currentRemainder) ã‚’è¨ˆç®—
				currentRemainder = workingDividend - product;

				// --- HTML ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆ ---

				// ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å¼•ãç®—ã®å¯¾è±¡ã¨ãªã‚‹å‰²ã‚‰ã‚Œã‚‹æ•°ã®éƒ¨åˆ†ã®é–‹å§‹æ¡ã‚’æ±ºå®š
				// å•†ãŒç¢ºå®šã—ãŸæ¡æ•°ã‹ã‚‰é€†ç®—ã—ã¦ã€å‰²ã‚‰ã‚Œã‚‹æ•°ã®é•·ã•ã¨ã®å·®åˆ†ã‚’æ±‚ã‚ã‚‹

				const currentStepLength = (dividendIndex - 1);
				const productStr = String(product);

				// A. å¼•ãæ•° (Product) ã®è¡Œ
				// å•†ã®æ¡ (quotientIndex) ã«å¯¾å¿œã™ã‚‹å‰²ã‚‰ã‚Œã‚‹æ•° (strX) ã®æ¡ã®ä½ç½®ã«åˆã‚ã›ã‚‹

				// å‰²ã‚‰ã‚Œã‚‹æ•°ã®å…¨ä½“ã‚’åŸºæº–ã¨ã—ãŸã€ã“ã® Product ã®é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
				const productStartCol = dividendIndex - productStr.length;

				let productPadding = ' '.repeat(productStartCol);

				stepsHTML += `<div class="step-row">`;
				stepsHTML += `<div class="step-content" style="width: ${mainCols * 1.1 + 0.5}em;">`;
				stepsHTML += `<span class="step-operator">-</span>`;
				stepsHTML += `<span style="flex-grow: 1; text-align: right;">${productPadding}${productStr}</span>`;
				stepsHTML += `</div>`;
				stepsHTML += `</div>`;

				// B. ç·š
				stepsHTML += `<div class="step-row"><div class="step-line"></div></div>`;

				// C. å¼•ãç®—ã®çµæœ (currentRemainder) + æ–°ã—ãå¼•ãä¸‹ã‚ã™æ¬¡ã®æ¡
				let resultStr = String(currentRemainder);
				let nextDigit = dividendIndex < strX.length ? strX[dividendIndex] : '';

				// ä½™ã‚Š(resultStr)ãŒé…ç½®ã•ã‚Œã‚‹é–‹å§‹æ¡
				const remainderStartCol = dividendIndex - resultStr.length;
				let remainderPadding = ' '.repeat(remainderStartCol);

				stepsHTML += `<div class="step-row">`;
				stepsHTML += `<div class="step-content" style="width: ${mainCols * 1.1 + 0.5}em;">`;
				stepsHTML += `<span style="flex-grow: 1; text-align: right;">${remainderPadding}${resultStr}${nextDigit}</span>`;
				stepsHTML += `</div>`;
				stepsHTML += `</div>`;

				workingDividend = currentRemainder; // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãŸã‚ã«ä½™ã‚Šã‚’è¨­å®š
			}


			// --- å‰²ã‚Šç®—å…¨ä½“æ§‹é€ ã®HTMLæ§‹ç¯‰ ---
			let maxStepsWidth = (strX.length + 1) * 1.1 + 10;

			// å•†ã®HTMLã‚’ç”Ÿæˆ
			let quotientHTML = '';
			for (const digit of strQ) {
				quotientHTML += `<div class="quotient-digit">${digit}</div>`;
			}

			// æœ€çµ‚ä½™ã‚Šã®è¡¨ç¤º
			let finalRemainderStr = String(currentRemainder);

			let html = `
                <div class="division-container" style="min-width: ${maxStepsWidth}em;">
                    <div class="quotient-row" style="min-width: ${maxStepsWidth - 10}em;">
                        <div style="flex-grow: 1;"></div>
                        ${quotientHTML}
                    </div>
                    <div class="division-main">
                        <div class="division-symbol">${initialY}</div>
                        <div class="division-steps" style="min-width: ${maxStepsWidth - 10}em;">
                            <div class="step-row">
                                <div class="step-content" style="width: 100%; justify-content: flex-start; padding-left: 0.5em;">${strX}</div>
                            </div>
                            
                            ${stepsHTML}
                            
                            <div class="remainder-line" style="text-align: right; padding-right: 0.5em;">ã‚. ${finalRemainderStr}</div>
                        </div>
                    </div>
                </div>
            `;

			processElement.innerHTML = html;
		}


		// =======================================================
		// ã‚·ãƒ³ãƒ—ãƒ«ãªé€”ä¸­å¼ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ç­†ç®—ä»¥å¤–ç”¨) 
		// =======================================================
		function showSimpleProcess(rowId, x, y, operator, result) {
			const processElement = document.getElementById(`process_${rowId}`);
			if (!processElement) return;

			const displayOperator = operator === '*' ? 'Ã—' : operator === '/' ? 'Ã·' : operator;

			processElement.innerHTML = `ã—ãï¼š${x} ${displayOperator} ${y} = ${result}`;
		}

		// =======================================================
		// 9. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆè¨ˆç®—ï¼‰å‡¦ç† 
		// =======================================================
		document.getElementById('calculationForm').addEventListener('submit', function (event) {
			event.preventDefault();

			const allGroups = calculationRowsContainer.querySelectorAll('.calculation-row-group');

			allGroups.forEach(group => {
				const rowId = group.id.split('_')[1];

				const input1 = document.getElementById(`number1_${rowId}`);
				const input2 = document.getElementById(`number2_${rowId}`);
				const resultInput = document.getElementById(`result_${rowId}`);
				const operatorElement = document.getElementById(`operator_${rowId}`);

				const operator = operatorElement ? operatorElement.getAttribute('data-operator') : '+';
				let x = parseFloat(input1.value);
				let y = parseFloat(input2.value);
				let result;

				if (isNaN(x) || isNaN(y)) {
					resultInput.value = 'Error';
					document.getElementById(`process_${rowId}`).innerHTML = 'ã—ããŒã¾ã¡ãŒã£ã¦ã„ã‚‹ã‚ˆï¼';
					return;
				}

				if (operator === '/') {
					if (y === 0) {
						resultInput.value = 'Div/0';
						document.getElementById(`process_${rowId}`).innerHTML = 'ãœã‚ã§ã¯ã‚ã‚Œãªã„ã‚ˆï¼';
						return;
					}
					result = Math.round((x / y) * 100) / 100;
				} else {
					switch (operator) {
						case '+':
							result = x + y;
							break;
						case '-':
							result = x - y;
							break;
						case '*':
							result = x * y;
							break;
						default:
							result = x + y;
					}
				}

				switch (operator) {
					case '+':
						showAdditionProcess(rowId, x, y);
						break;
					case '-':
						showSubtractionProcess(rowId, x, y);
						break;
					case '*':
						showMultiplicationProcess(rowId, x, y);
						break;
					case '/':
						// å‰²ã‚Šç®—ã¯æ•´æ•°åŒå£«ã®ã¿å¯¾å¿œ
						if (Number.isInteger(x) && Number.isInteger(y)) {
							showDivisionProcess(rowId, x, y);
						} else {
							showSimpleProcess(rowId, x, y, operator, result);
						}
						break;
					default:
						showSimpleProcess(rowId, x, y, operator, result);
				}

				resultInput.value = result;
			});
		});

		// -------------------------------------------------------------
		// ğŸ”‘ ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†å®šç¾© (å‹•ä½œã«å¿…è¦ãªé–¢æ•°)
		// -------------------------------------------------------------

		function adjustKeypadPosition(targetElement) {
			const rect = targetElement.getBoundingClientRect();
			keypad.style.top = (rect.bottom + window.scrollY + 5) + 'px';
			keypad.style.left = (rect.left + window.scrollX) + 'px';
		}

		function handleFocus(event) {
			event.preventDefault();
			const target = event.currentTarget;
			activeRowId = target.id.split('_')[1];
			currentInput = target;

			setTimeout(() => {
				keypad.classList.remove('keypad-hidden');
				adjustKeypadPosition(target);
			}, 50);

			const currentOp = document.getElementById(`operator_${activeRowId}`).getAttribute('data-operator');
			operatorButtons.forEach(btn => {
				btn.classList.remove('selected');
				if (btn.getAttribute('data-operator') === currentOp) {
					btn.classList.add('selected');
				}
			});
		}

		function attachInputListeners(container) {
			const inputs = container.querySelectorAll('input[id^="number"]');
			inputs.forEach(input => {
				input.addEventListener('focus', handleFocus);
			});
		}

		const initialGroup = document.getElementById('group_1');
		if (initialGroup) {
			const inputs = initialGroup.querySelectorAll('input[id^="number"]');
			inputs.forEach(input => {
				input.addEventListener('focus', handleFocus);
			});
		}

		function cloneAndAppendRow() {
			let rowCount = document.querySelectorAll('.calculation-row-group').length;
			rowCount++;
			const originalGroup = document.getElementById('group_1');
			if (!originalGroup) return;

			const newGroup = originalGroup.cloneNode(true);
			newGroup.id = `group_${rowCount}`;

			newGroup.querySelectorAll('input, span, div').forEach(el => {
				const idPrefix = el.id.split('_')[0];
				el.id = `${idPrefix}_${rowCount}`;
				if (el.name) {
					el.name = `${idPrefix}_${rowCount}`;
				}
				if (el.tagName === 'INPUT') {
					el.value = '';
				}
				if (el.tagName === 'SPAN') {
					el.textContent = '+';
					el.setAttribute('data-operator', '+');
				}
				if (el.classList.contains('calculation-process')) {
					el.innerHTML = '';
				}
			});

			calculationRowsContainer.appendChild(newGroup);

			attachInputListeners(newGroup);
		}

		addRowButton.addEventListener('click', cloneAndAppendRow);

		keypad.addEventListener('click', function (event) {
			if (event.target.tagName !== 'BUTTON' || !currentInput) {
				return;
			}
			const value = event.target.getAttribute('data-value');
			if (value === 'C') {
				currentInput.value = '';
			} else {
				currentInput.value += value;
			}
		});

		document.addEventListener('click', function (event) {
			const isOperatorBtn = event.target.closest('#operators');
			const isInput = event.target.tagName === 'INPUT' && (event.target.id.startsWith('number1') || event.target.id.startsWith('number2'));
			const isKeypad = keypad.contains(event.target);
			const isAddButton = event.target.id === 'addRowButton';
			const isCalculateButton = event.target.id === 'calculateSubmit';

			if (!isKeypad && !isInput && !isOperatorBtn && !isAddButton && !isCalculateButton) {
				keypad.classList.add('keypad-hidden');
				currentInput = null;
			}
		});

		operatorButtons.forEach(button => {
			button.addEventListener('click', function () {
				const selectedOperator = button.getAttribute('data-operator');
				const activeOperatorDisplay = document.getElementById(`operator_${activeRowId}`);
				if (activeOperatorDisplay) {
					const displayChar = selectedOperator === '*' ? 'Ã—' :
						selectedOperator === '/' ? 'Ã·' : selectedOperator;
					activeOperatorDisplay.textContent = displayChar;
					activeOperatorDisplay.setAttribute('data-operator', selectedOperator);
				}
				operatorButtons.forEach(btn => btn.classList.remove('selected'));
				button.classList.add('selected');
			});
		});
	</script>
</body>

</html>